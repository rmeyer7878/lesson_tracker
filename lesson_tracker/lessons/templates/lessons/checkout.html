<!-- lessons/templates/lessons/checkout.html -->

{% extends 'lessons/base.html' %}
{% block content %}
<div class="content-container">
<h2>Checkout</h2>
{% load custom_filters %}

<table>
    <thead>
        <tr>
            <th>Lesson</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
        {% for lesson_id, item in cart.items %}
        <tr>
            <td>{{ item.name }}</td>
            <td>{{ item.quantity }}</td>
            <td>${{ item.price|floatformat:2 }}</td>
            <td>${{ item.price|mul:item.quantity|floatformat:2 }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<p><strong>Grand Total:</strong> ${{ total|floatformat:2 }}</p>

<button id="checkout-button" type="button">Confirm and Pay</button>

<script src="https://js.stripe.com/v3/"></script>

<script>
    document.getElementById("checkout-button").addEventListener("click", function () {
        var stripe = Stripe("{{ stripe_public_key }}");

        if ("{{ checkout_session_id }}") {
            stripe.redirectToCheckout({
                sessionId: "{{ checkout_session_id }}"
            }).then(function (result) {
                if (result.error) {
                    alert(result.error.message);
                }
            });
        } else {
            alert("An error occurred. Please try again later.");
            console.error("Stripe checkout session ID is missing.");
        }
    });
</script>
</div>
{% endblock %}
